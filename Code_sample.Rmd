---
title: "Code Sample"
output: html_document
date: "2023-03-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is a shortened version of Extracellular Enzyme Activity data import/cleaning and exploration from mirobial river communities. The data from the Tecan SPARK plate reader must be saved as they are (xlsx, default reading locations in the excel sheet etc.). Data must be saved by it's name as Sample day number_replicate_factor (ex: S09_B_C3 in my case represents 9th day sample, replicate B, factor level C3)

Functions for reading the plate results from the excel sheets. The anchor is set according to the plate design and must be changed for different enzymes at different locations. 

```{r}
read_positive_cells <- function(data) {
  return(ifelse(data[1,1:5]>0, data[2,1:5], 0))
}

read_glu <-  function(df){
 
   measurement=read_xlsx(df,  range = anchored(anchor = "Z51", dim = c(2L, 5L), input = NULL, col_names = NULL, 
                                               byrow = FALSE), col_names=paste0("rep", seq_along(1:5)))
  
  final=read_positive_cells(measurement)
  return(final)
}


read_xyl <-  function(df){
  measurement=read_xlsx(df,  range = anchored(anchor = "Z57", dim = c(2L, 5L), input = NULL, col_names = NULL,
                                              byrow = FALSE),  col_names=paste0("rep", seq_along(1:5)))
  final=read_positive_cells(measurement)
  return(final)
}

```

Functions needed for data cleaning and appropriate naming
```{r}
name_change = function(x) {
   substr(x$sample, 11, nchar(x$sample)-5)
}

enzyme_as_data_table = function(x, func) {
  df=as.data.table(t(mapply(x, FUN=func, USE.NAMES = TRUE)), keep.rownames="sample")
  df$sample = name_change(df)
  
  return(df)
}

convert_to_numeric = function(x){
  x[,`:=`(V1 = as.numeric(V1),
            V2 = as.numeric(V2),
            V3 = as.numeric(V3), 
            V4 = as.numeric(V4),
            V5 = as.numeric(V5))]
}

is.nan.data.frame <- function(x) {
  do.call(cbind, lapply(x, is.nan))
}

is.inf.data.frame <- function(x) {
  do.call(cbind, lapply(x, is.infinite))
}
```

Functions for calculating the median and the ratio of the two enzymes at hand. 
```{r}
calculate_median = function (x) {
  x$median=apply(x[,-1], 1, median, na.rm=T)
  return(x)
}

calculate_xyl_gly = function (x) {
  data.table(sample = x$Gly$sample, xyl_gly = map2_dfr(x$Gly[,"median"],x$Xyl[,"median"],"sample", 
                                       .f= ~.y / .x, ))
}
```
```{r}
BiblioDir = list.dirs(path = "data2", full.names =T, recursive = F)
meta = list.files(BiblioDir, full.names = T)
paths = meta[substr(meta, 7,9)%in%c("S09", "S13", "S16", "S19")]#The real community samples (others are water)
head(paths)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
